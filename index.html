<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Qualit√© de l‚Äôeau ‚Äî France</title>
  <!-- Favicon standard -->
<link rel="icon" type="image/png" sizes="32x32" href="assets/icon.png">
<link rel="icon" type="image/png" sizes="192x192" href="assets/icon.png">

<!-- Icons Library -->
<script src="https://unpkg.com/lucide@latest"></script>

<!-- iPhone / iOS homescreen icon -->
<link rel="apple-touch-icon" href="assets/icon.png">

<!-- Permet le mode app iOS -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Qualit√© Eau">
  <meta name="description" content="Qualit√© de l‚Äôeau potable en France (Hub‚ÄôEau). Recherche par ville, code postal ou g√©olocalisation." />

  <style>
/* Premium iOS-like dark theme (simple, clean, card-first) */
:root{
  --bg:#1C1C1E;          /* app background */
  --card:#2D2D2F;        /* card background */
  --card2:#262629;       /* inner surfaces */
  --text:#F5F5F7;
  --muted:#A1A1AA;
  --border:rgba(255,255,255,.08);

  --shadow: 0 18px 45px rgba(0,0,0,.50);
  --shadow2: 0 10px 25px rgba(0,0,0,.38);
  --radius:24px;

  --btn-primary:#333333; /* validate button */
  --btn-primary-h:#3A3A3A;

  --focus: 0 0 0 4px rgba(255,255,255,.10);

  /* Status */
  --ok-bg: rgba(52, 211, 153, .16);
  --ok-tx: #34D399;
  --bad-bg: rgba(248, 113, 113, .16);
  --bad-tx: #F87171;
  --unk-bg: rgba(203, 213, 225, .14);
  --unk-tx: #CBD5E1;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
  color:var(--text);
  background:
    radial-gradient(900px 520px at 15% -10%, rgba(255,255,255,.06), transparent 60%),
    radial-gradient(800px 520px at 85% 0%, rgba(255,255,255,.04), transparent 55%),
    linear-gradient(180deg, #151516, var(--bg));
  min-height:100vh;
}

.wrap{
  max-width:980px;
  margin:0 auto;
  padding:28px 18px 64px;
}

header{
  text-align:center;
  padding:18px 0 24px;
}

.pill{
  display:inline-flex;
  align-items:center;
  gap:10px;
  padding:10px 14px;
  border:1px solid var(--border);
  border-radius:999px;
  background: rgba(45,45,47,.70);
  box-shadow: var(--shadow2);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  font-size:13px;
  color:var(--muted);
}

h1{
  margin:14px 0 8px;
  font-size:clamp(28px,3.6vw,44px);
  letter-spacing:-0.03em;
  line-height:1.05;
}

.sub{
  margin:0 auto;
  max-width:64ch;
  color:var(--muted);
  font-size:15.5px;
  line-height:1.55;
}

.grid{
  display:grid;
  gap:16px;
  grid-template-columns:1fr;
  margin-top:22px;
}

@media (min-width:900px){
  .grid{grid-template-columns:1.1fr .9fr; align-items:start}
}

/* Main cards */
.card{
  position:relative;
  background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.00)), var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  box-shadow: var(--shadow);
  overflow:hidden;
}

/* subtle top glow */
.card::before{
  content:"";
  position:absolute;
  inset:-1px -1px auto -1px;
  height:110px;
  background: radial-gradient(420px 140px at 18% 20%, rgba(255,255,255,.08), transparent 65%);
  pointer-events:none;
}

.card-header{
  position:relative;
  padding:18px 18px 12px;
  border-bottom:1px solid rgba(255,255,255,.06);
}

.card-title{
  font-size:16px;
  margin:0 0 6px;
  letter-spacing:-0.01em;
}

.card-desc{
  margin:0;
  color:var(--muted);
  font-size:13.5px;
  line-height:1.45;
}

.card-body{
  padding:16px 18px 18px;
}

.row{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
}

/* Inputs */
.input{
  flex:1 1 260px;
  border:1px solid rgba(255,255,255,.10);
  border-radius:18px;
  padding:12px 14px;
  font-size:15px;
  outline:none;
  background: rgba(28,28,30,.72);
  color:var(--text);
  box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
}

.input::placeholder{color:rgba(161,161,170,.85)}

.input:focus{
  border-color: rgba(255,255,255,.16);
  box-shadow: var(--focus);
}

/* Buttons */
.btn{
  border:1px solid rgba(255,255,255,.10);
  background: rgba(28,28,30,.72);
  color:var(--text);
  padding:12px 14px;
  border-radius:18px;
  font-weight:650;
  cursor:pointer;
  transition: transform .05s ease, background .18s ease, border-color .18s ease;
  box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
}

.btn:hover{
  background: rgba(38,38,41,.85);
}

.btn:active{
  transform: scale(.99);
}

.btn-primary{
  background: var(--btn-primary);
  border-color: rgba(255,255,255,.08);
  box-shadow:
    0 10px 22px rgba(0,0,0,.35),
    inset 0 1px 0 rgba(255,255,255,.08);
}

.btn-primary:hover{
  background: var(--btn-primary-h);
}

.btn:disabled,
.btn-primary:disabled{
  opacity:.6;
  cursor:not-allowed;
}

/* Helper text */
.hint{
  margin-top:10px;
  color:var(--muted);
  font-size:13px;
  line-height:1.45;
}

.divider{
  height:1px;
  background: rgba(255,255,255,.08);
  margin:14px 0;
}

/* Choices list */
.choices{
  display:flex;
  flex-direction:column;
  gap:10px;
  margin-top:12px;
}

.choice{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  padding:12px 14px;
  border:1px solid rgba(255,255,255,.10);
  border-radius:18px;
  background: rgba(28,28,30,.60);
  cursor:pointer;
  transition: background .18s ease, transform .05s ease, border-color .18s ease;
}

.choice:hover{
  background: rgba(38,38,41,.82);
  border-color: rgba(255,255,255,.14);
}

.choice:active{transform:scale(.99)}

.choice small{
  color:var(--muted);
  display:block;
  margin-top:2px;
}

/* KPIs */
.kpis{
  display:grid;
  grid-template-columns:1fr;
  gap:12px;
}

@media (min-width:520px){
  .kpis{grid-template-columns:1fr 1fr}
}

.kpi{
  border:1px solid rgba(255,255,255,.08);
  border-radius:20px;
  padding:14px;
  background:
    linear-gradient(180deg, rgba(255,255,255,.03), transparent),
    rgba(28,28,30,.55);
  box-shadow: var(--shadow2);
}

.kpi .label{
  font-size:12.5px;
  color:var(--muted);
  margin-bottom:6px;
}

.kpi .value{
  font-size:16px;
  font-weight:760;
  letter-spacing:-0.01em;
}

/* Badges */
.badge{
  display:inline-flex;
  align-items:center;
  padding:8px 12px;
  border-radius:999px;
  font-weight:760;
  font-size:13px;
  border:1px solid rgba(255,255,255,.08);
  box-shadow: inset 0 1px 0 rgba(255,255,255,.08);
}

.badge.ok{background:var(--ok-bg); color:var(--ok-tx)}
.badge.bad{background:var(--bad-bg); color:var(--bad-tx)}
.badge.unk{background:var(--unk-bg); color:var(--unk-tx)}

.status-line{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
  margin-top:6px;
}

.muted{color:var(--muted)}

/* Toast / loader */
.toast{
  display:none;
  margin-top:10px;
  padding:12px 14px;
  border-radius:18px;
  border:1px solid rgba(248,113,113,.22);
  background: rgba(248,113,113,.10);
  color: var(--bad-tx);
  font-size:13.5px;
  line-height:1.45;
}

.toast.show{display:block}

.loader{
  display:none;
  margin-top:12px;
  color:var(--muted);
  font-size:13.5px;
}

.loader.show{display:block}

/* Footer */
.footer{
  margin-top:22px;
  text-align:center;
  color:var(--muted);
  font-size:12.5px;
  line-height:1.55;
}

/* Accessibility */
@media (prefers-reduced-motion: reduce){
  .btn,.choice{transition:none}
}

.accordion{ display:flex; flex-direction:column; gap:10px; }

.acc-btn{
  width:100%;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  padding:12px 14px;
  border:1px solid rgba(255,255,255,.10);
  border-radius:18px;
  background: rgba(28,28,30,.60);
  color: var(--text);
  cursor:pointer;
  font-weight:750;
  box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
}

.acc-btn:hover{ background: rgba(38,38,41,.82); border-color: rgba(255,255,255,.14); }
.acc-right{ display:flex; align-items:center; gap:10px; }
.acc-count{ color: var(--muted); font-weight:650; font-size:12.5px; }
.acc-chev{ color: var(--muted); transition: transform .15s ease; }

.acc-panel{
  display:none;
  padding: 0 2px;
}

.acc-panel.open{ display:block; }
.acc-btn.open .acc-chev{ transform: rotate(180deg); }

.acc-content{
  margin-top:8px;
  border:1px solid rgba(255,255,255,.08);
  border-radius:18px;
  background:
    linear-gradient(180deg, rgba(255,255,255,.03), transparent),
    rgba(28,28,30,.55);
  box-shadow: var(--shadow2);
  padding: 12px 12px;
}

.param-table{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  font-size:13px;
}

.param-table th, .param-table td{
  padding:10px 10px;
  border-bottom:1px solid rgba(255,255,255,.08);
  vertical-align:top;
}

.param-table th{
  text-align:left;
  color: var(--muted);
  font-weight:700;
  font-size:12px;
}

.param-table tr:last-child td{ border-bottom:none; }

.code-pill{
  display:inline-flex;
  padding:4px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.06);
  color: var(--muted);
  font-size:12px;
  font-weight:650;
}


/* Status icons (Lucide) */
.status-cell{
  display:flex;
  align-items:center;
  gap:10px;
}

.status-icon{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width:18px;
  height:18px;
  color: var(--unk-tx);
}

.status-icon.ok{ color: var(--ok-tx); }
.status-icon.bad{ color: var(--bad-tx); }
.status-icon.unk{ color: var(--unk-tx); }

.status-hint{
  color: var(--muted);
  font-size:12.5px;
  line-height:1.35;
}

/* Tooltip (desktop hover + mobile tap) */
.tip{
  position: relative;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.tip::after{
  content: attr(data-tip);
  position: absolute;
  left: 50%;
  bottom: calc(100% + 10px);
  transform: translateX(-50%);
  min-width: 180px;
  max-width: 260px;
  padding: 10px 12px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(18,18,20,.96);
  color: #F5F5F7;
  font-size: 12.5px;
  line-height: 1.35;
  box-shadow: 0 18px 45px rgba(0,0,0,.55);
  white-space: normal;
  opacity: 0;
  pointer-events: none;
  transition: opacity .12s ease;
  z-index: 50;
}

/* small arrow */
.tip::before{
  content: "";
  position: absolute;
  left: 50%;
  bottom: calc(100% + 4px);
  transform: translateX(-50%);
  border: 7px solid transparent;
  border-top-color: rgba(18,18,20,.96);
  opacity: 0;
  transition: opacity .12s ease;
  z-index: 50;
}

/* Desktop hover */
@media (hover:hover) and (pointer:fine){
  .tip:hover::after,
  .tip:hover::before{
    opacity: 1;
  }
}

/* Mobile click/tap toggled class */
.tip.is-open::after,
.tip.is-open::before{
  opacity: 1;
  pointer-events: auto;
}
</style>


</head>

<body>
  <div class="wrap">
    <header>
      <div class="pill">üíß Donn√©es officielles ‚Ä¢ Hub‚ÄôEau ‚Ä¢ Contr√¥le sanitaire</div>
      <h1>Qualit√© de l‚Äôeau potable<br/>pr√®s de chez vous</h1>
      <p class="sub">
        Recherche par <strong>ville</strong> ou <strong>code postal</strong>, ou via votre <strong>g√©olocalisation</strong>.
        Affiche la conformit√© et la date de la derni√®re analyse disponible.
      </p>
    </header>

    <div class="grid">
      <!-- Search card -->
      <section class="card">
        <div class="card-header">
          <h2 class="card-title">Trouver votre commune</h2>
          <p class="card-desc">Entrez une ville (ex: ‚ÄúParis‚Äù) ou un code postal (ex: ‚Äú75011‚Äù).</p>
        </div>
        <div class="card-body">
          <div class="row">
            <input id="q" class="input" placeholder="Ville ou code postal‚Ä¶" autocomplete="off" />
            <button id="btnSearch" class="btn btn-primary">Valider</button>
            <button id="btnLocate" class="btn">Me localiser</button>
          </div>

          <div id="loader" class="loader">Chargement‚Ä¶</div>
          <div id="toast" class="toast"></div>

          <div class="hint">
            Astuce : si plusieurs communes correspondent (cas fr√©quent avec un code postal),
            choisissez la bonne dans la liste.
          </div>

          <div id="choices" class="choices" aria-live="polite"></div>
        </div>
      </section>

      <!-- Results card -->
      <section class="card" id="resultsCard" style="display:none;">
        <div class="card-header">
          <h2 class="card-title">R√©sultats</h2>
          <p class="card-desc">R√©sum√© bas√© sur le <strong>dernier pr√©l√®vement</strong> disponible pour la commune.</p>
        </div>
        <div class="card-body">
          <div class="kpis">
            <div class="kpi">
              <div class="label">Ville</div>
              <div class="value" id="kpiCity">‚Äî</div>
              <div class="muted" style="margin-top:6px;font-size:12.5px" id="kpiInsee">‚Äî</div>
            </div>

            <div class="kpi">
              <div class="label">Nb d‚Äôhabitants</div>
              <div class="value" id="kpiPop">‚Äî</div>
              <div class="muted" style="margin-top:6px;font-size:12.5px">Source: geo.api.gouv.fr</div>
            </div>

            <div class="kpi">
              <div class="label">üíß L'eau du robinet est :</div>
              <div class="status-line">
                <span id="kpiOverallBadge" class="badge unk">Inconnu</span>
                <span class="muted" id="kpiOverallText">‚Äî</span>
              </div>
            </div>

            <div class="kpi">
              <div class="label">ü¶† Conformit√© bact√©riologique</div>
              <div class="status-line">
                <span id="kpiBactBadge" class="badge unk">‚Äî</span>
              </div>
            </div>

            <div class="kpi">
              <div class="label">üß™ Conformit√© chimique</div>
              <div class="status-line">
                <span id="kpiChemBadge" class="badge unk">‚Äî</span>
              </div>
            </div>

            <div class="kpi">
              <div class="label">PFAS</div>
              <div class="status-line">
                <span id="kpiPFASBadge" class="badge unk">‚Äî</span>
                <span class="muted" id="kpiPFASText">‚Äî</span>
              </div>
            </div>


            <div class="kpi">
              <div class="label">Date de derni√®re analyse</div>
              <div class="value" id="kpiLastDate">‚Äî</div>
              <div class="muted" style="margin-top:6px;font-size:12.5px" id="kpiSampleId">‚Äî</div>
            </div>
          </div>

          <div class="divider"></div>

          <!-- Analyses d√©taill√©es (accord√©ons) -->
<div class="card" style="margin-top:14px;">
  <div class="card-header">
    <h2 class="card-title">Analyses d√©taill√©es</h2>
    <p class="card-desc">D√©tails du <strong>dernier pr√©l√®vement</strong> (si mesur√©).</p>
  </div>

  <div class="card-body">
    <div class="accordion">
      <button class="acc-btn" type="button" data-acc="micro">
        <span>ü¶† Microbiologique</span>
        <span class="acc-right"><span id="countMicro" class="acc-count">‚Äî</span> <span class="acc-chev">‚ñæ</span></span>
      </button>
      <div class="acc-panel" id="panel-micro">
        <div id="microContent" class="acc-content muted">‚Äî</div>
      </div>

      <button class="acc-btn" type="button" data-acc="chem">
        <span>‚öóÔ∏è Chimique</span>
        <span class="acc-right"><span id="countChem" class="acc-count">‚Äî</span> <span class="acc-chev">‚ñæ</span></span>
      </button>
      <div class="acc-panel" id="panel-chem">
        <div id="chemContent" class="acc-content muted">‚Äî</div>
      </div>

      <button class="acc-btn" type="button" data-acc="phys">
        <span>üíß Physique</span>
        <span class="acc-right"><span id="countPhys" class="acc-count">‚Äî</span> <span class="acc-chev">‚ñæ</span></span>
      </button>
      <div class="acc-panel" id="panel-phys">
        <div id="physContent" class="acc-content muted">‚Äî</div>
      </div>
    </div>

    <div class="muted" style="margin-top:12px; font-size:12.5px; line-height:1.5">
      Les param√®tres r√©ellement mesur√©s varient selon les campagnes et les r√©seaux. Si une cat√©gorie est vide,
      c‚Äôest souvent que ce n‚Äô√©tait pas mesur√© sur ce pr√©l√®vement.
    </div>
  </div>
</div>
          <div class="divider"></div>


          <div class="muted" style="font-size:13px;line-height:1.5">
            <strong>Note :</strong> Les r√©sultats Hub‚ÄôEau sont √† la granularit√© des <em>r√©sultats d‚Äôanalyses</em>,
            et les conclusions sanitaires sont r√©p√©t√©es sur chaque ligne d‚Äôanalyse d‚Äôun m√™me pr√©l√®vement.
            Ici on affiche le r√©sum√© du <strong>dernier pr√©l√®vement</strong> trouv√©.
          </div>
        </div>
      </section>
    </div>

    <div class="footer">
      Source qualit√© de l‚Äôeau : Hub‚ÄôEau ‚Äî API ‚ÄúQualit√© de l‚Äôeau potable‚Äù (DIS). Mise √† jour mensuelle.<br/>
      Cette page fait des appels directs aux API (pas de serveur, pas de base de donn√©es). </br>Designed with AI by <a href="http://vikram.digital/">Vikram Sanath</a>
    </div>
  </div>

  <script>
    // -----------------------------
    // Small helpers
    // -----------------------------
    const $ = (id) => document.getElementById(id);

    function showToast(msg){
      const el = $("toast");
      el.textContent = msg;
      el.classList.add("show");
    }
    function clearToast(){
      const el = $("toast");
      el.textContent = "";
      el.classList.remove("show");
    }
    function setLoading(isLoading){
      $("loader").classList.toggle("show", isLoading);
      $("btnSearch").disabled = isLoading;
      $("btnLocate").disabled = isLoading;
    }

    function formatInt(n){
      try { return new Intl.NumberFormat("fr-FR").format(n); }
      catch { return String(n); }
    }
    function formatDateISOToFR(iso){
      if(!iso) return "‚Äî";
      const d = new Date(iso);
      if(Number.isNaN(d.getTime())) return iso;
      return d.toLocaleDateString("fr-FR", { year:"numeric", month:"long", day:"2-digit" });
    }

    function normalizeOuiNon(value){
  if(value === null || value === undefined || value === ""){
    return { label: "‚Äî", cls: "unk" };
  }

  const v = String(value).trim().toUpperCase();

  switch(v){
    case "C":
      return { label: "Conforme", cls: "ok" };

    case "N":
      return { label: "Non conforme", cls: "bad" };

    case "D":
      return { label: "Conforme (d√©rogation)", cls: "ok" };

    case "S":
      return { label: "Non mesur√©", cls: "unk" };

    default:
      return { label: v, cls: "unk" };
  }
}


    function normalizeConformityOverall(conclusion){
      if(!conclusion) return { label:"Inconnu", cls:"unk", text:"Aucune conclusion trouv√©e." };
      const s = String(conclusion).toLowerCase();
      if(s.includes("non") || s.includes("d√©favorable") || s.includes("defavorable")){
        return { label:"Non conforme", cls:"bad", text:String(conclusion) };
      }
      if(s.includes("conforme") || s.includes("favorable")){
        return { label:"Conforme", cls:"ok", text:String(conclusion) };
      }
      return { label:"Inconnu", cls:"unk", text:String(conclusion) };
    }


    // -----------------------------
    // PFAS CALCULATOR
    // -----------------------------

    const PFAS_KEYWORDS = [
      "PFAS","PFOS","PFOA","PFHXS","PFNA","PFDA","PFBS","PFHP","PFUNA","PFDOA","PFTRDA","PFTEDA"
    ];

    function detectPFAS(rows, sampleId){
  const badge = $("kpiPFASBadge");
  const text  = $("kpiPFASText");

  if(!badge || !text) return;

  if(!rows || rows.length === 0){
    badge.className = "badge unk";
    badge.textContent = "‚Äî";
    text.textContent = "Aucune donn√©e.";
    return;
  }

  const PFAS_KEYWORDS = [
    "PFAS","PFOS","PFOA","PFHXS","PFNA","PFDA","PFBS","PFHP","PFUNA","PFDOA","PFTRDA","PFTEDA"
  ];

  const sampleRows = rows.filter(r => r.code_prelevement === sampleId);

  const pfasRows = sampleRows.filter(r => {
    const label = (r.libelle_parametre || "").toUpperCase();
    return PFAS_KEYWORDS.some(k => label.includes(k));
  });

  // ‚ö™ Non mesur√©
  if(pfasRows.length === 0){
    badge.className = "badge unk";
    badge.textContent = "Non mesur√©";
    text.textContent = "Aucun param√®tre PFAS analys√©.";
    return;
  }

  // Trouver la valeur max d√©tect√©e
  let maxValue = null;
  let maxRow = null;

  for(const r of pfasRows){
    const val = Number(r.resultat_numerique);
    if(!isNaN(val)){
      if(maxValue === null || val > maxValue){
        maxValue = val;
        maxRow = r;
      }
    }
  }

  // üü¢ Aucun d√©tect√© (mesur√© mais 0)
  if(maxValue === 0){
    badge.className = "badge ok";
    badge.textContent = "Aucun d√©tect√©";
    text.textContent = "PFAS analys√©s ‚Äî aucune d√©tection.";
    return;
  }

  // üü° D√©tect√©
  badge.className = "badge bad";
  badge.textContent = "PFAS d√©tect√©s";

  if(maxRow){
    const unit = maxRow.libelle_unite || "";
    text.textContent = `${maxRow.libelle_parametre} : ${maxValue} ${unit}`.trim();
  }else{
    text.textContent = "Pr√©sence d√©tect√©e.";
  }
}


// ---------- Regulatory thresholds (hardcoded) ----------
// type: "limit" (limite de qualit√©) or "ref" (r√©f√©rence de qualit√©)
// rule: "max" / "range" / "special" / "none"
const THRESHOLDS = [
  // ü¶† Microbiologique
  { key: "ecoli",       match: [/ESCHERICHIA\s*COLI/i, /\bE\.\s*COLI\b/i], type:"limit", rule:"max", value:0, unit:"/100 mL" },
  { key: "enteroco",    match: [/ENT[√âE]ROCO/i, /ENTEROCO/i],             type:"limit", rule:"max", value:0, unit:"/100 mL" },
  { key: "coliformes",  match: [/COLIFORM/i],                            type:"ref",   rule:"max", value:0, unit:"/100 mL" },
  { key: "revivifiables", match: [/REVIVIFIABLE/i, /GERMES/i],            type:"ref",   rule:"none", note:"Pas de seuil fixe (plut√¥t variation anormale)." },

  // ‚öóÔ∏è Chimique - Nitrates/nitrites
  { key: "nitrates",    match: [/NITRAT/i],   type:"limit", rule:"max", value:50,   unit:"mg/L" },
  { key: "nitrites",    match: [/NITRIT/i],   type:"limit", rule:"max", value:0.5,  unit:"mg/L" },

  // ‚öóÔ∏è Chimique - Pesticides (r√®gles g√©n√©riques)
  // On ne peut pas reconna√Ætre "tous les pesticides" sans liste compl√®te, donc:
  // - si libell√© contient "TOTAL PESTICIDES" => 0.50 ¬µg/L
  // - sinon si libell√© contient "PESTICIDE" => 0.10 ¬µg/L (par substance)
  { key: "pest_total",  match: [/TOTAL\s+PESTICID/i], type:"limit", rule:"max", value:0.5,  unit:"¬µg/L" },
  { key: "pest_indiv",  match: [/PESTICID/i],         type:"limit", rule:"max", value:0.1,  unit:"¬µg/L" },

  // ‚öóÔ∏è M√©taux lourds (core)
  { key: "lead",        match: [/PLOMB/i, /\bPB\b/i],   type:"limit", rule:"max", value:10, unit:"¬µg/L" },
  { key: "arsenic",     match: [/ARSENIC/i, /\bAS\b/i], type:"limit", rule:"max", value:10, unit:"¬µg/L" },
  { key: "cadmium",     match: [/CADMIUM/i, /\bCD\b/i], type:"limit", rule:"max", value:5,  unit:"¬µg/L" },
  { key: "mercury",     match: [/MERCURE/i, /\bHG\b/i], type:"limit", rule:"max", value:1,  unit:"¬µg/L" },
  { key: "nickel",      match: [/NICKEL/i, /\bNI\b/i],  type:"limit", rule:"max", value:20, unit:"¬µg/L" },
  { key: "chromium",    match: [/CHROME/i, /CHROMIUM/i, /\bCR\b/i], type:"limit", rule:"max", value:50, unit:"¬µg/L" },

  // ‚öóÔ∏è Solvants (core)
  { key: "benzene",     match: [/BENZ[√àE]NE/i], type:"limit", rule:"max", value:1,  unit:"¬µg/L" },
  { key: "tce_pce",     match: [/TRICHLORO[ -]?√âTHYL[√àE]NE/i, /T[√âE]TRACHLORO[ -]?√âTHYL[√àE]NE/i], type:"limit", rule:"special", note:"Limite 10 ¬µg/L pour la somme TCE+PCE (si tu as les 2 s√©par√©s, il faut les sommer)." },

  // üíß Physique
  { key: "ph",          match: [/\bpH\b/i, /IONS\s+HYDROG/i], type:"ref", rule:"range", min:6.5, max:9, unit:"unit√©s pH" },
  { key: "conduct",     match: [/CONDUCTIV/i], type:"ref", rule:"range", min:180, max:1000, unit:"¬µS/cm@20¬∞C", note:"Ou 200‚Äì1100 ¬µS/cm √† 25¬∞C." },
  { key: "temp",        match: [/TEMP[√âE]RAT/i], type:"ref", rule:"max", value:25, unit:"¬∞C" },
  { key: "turb",        match: [/TURBID/i], type:"limit", rule:"max", value:1.0, unit:"NFU" },

  // üß™ PFAS
  // Le contr√¥le r√©glementaire se fait sur la SOMME des 20 PFAS
  { key: "pfas20_sum",  match: [/SOMME.*20.*PFAS/i, /\bPFAS[- ]?20\b/i], type:"limit", rule:"max", value:0.1, unit:"¬µg/L", note:"Somme des 20 PFAS (directive)."}
];



    // -----------------------------
    // Geo API (communes) ‚Äî get INSEE + population
    // -----------------------------
    async function geoSearchByPostal(codePostal){
      const url = new URL("https://geo.api.gouv.fr/communes");
      url.searchParams.set("codePostal", codePostal);
      url.searchParams.set("fields", "nom,code,population,codesPostaux");
      url.searchParams.set("format", "json");
      url.searchParams.set("limit", "10");
      const r = await fetch(url.toString());
      if(!r.ok) throw new Error("Geo API error");
      return await r.json();
    }

    async function geoSearchByName(name){
      const url = new URL("https://geo.api.gouv.fr/communes");
      url.searchParams.set("nom", name);
      url.searchParams.set("boost", "population");
      url.searchParams.set("fields", "nom,code,population,codesPostaux");
      url.searchParams.set("format", "json");
      url.searchParams.set("limit", "10");
      const r = await fetch(url.toString());
      if(!r.ok) throw new Error("Geo API error");
      return await r.json();
    }

    async function geoByLatLon(lat, lon){
      const url = new URL("https://geo.api.gouv.fr/communes");
      url.searchParams.set("lat", String(lat));
      url.searchParams.set("lon", String(lon));
      url.searchParams.set("fields", "nom,code,population,codesPostaux");
      url.searchParams.set("format", "json");
      url.searchParams.set("limit", "5");
      const r = await fetch(url.toString());
      if(!r.ok) throw new Error("Geo API error");
      return await r.json();
    }

    // -----------------------------
    // Hub'Eau ‚Äî latest sampling summary for a commune INSEE
    // Docs: https://hubeau.eaufrance.fr/page/api-qualite-eau-potable
    // -----------------------------
    async function fetchLatestWaterSample(inseeCode){
      // Keep it small: request only what we need, sorted descending by date.
      // Note: pagination depth limited; for "latest", first page is enough.
      const url = new URL("https://hubeau.eaufrance.fr/api/v1/qualite_eau_potable/resultats_dis");
      url.searchParams.set("code_commune", inseeCode);
      url.searchParams.set("size", "5000");         // default can be high; still ok for one commune & latest
      url.searchParams.set("page", "1");
      url.searchParams.set("sort", "desc");
      url.searchParams.set(
        "fields",
        [
          "code_prelevement",
          "date_prelevement",
          "conclusion_conformite_prelevement",
          "conformite_limites_bact_prelevement",
          "conformite_limites_pc_prelevement",
          "code_reseau",
          "nom_reseau",

          // champs d'analyse (pour l'accord√©on)
          "code_parametre",
          "libelle_parametre",
          "resultat_numerique",
          "resultat_textuel",
          "libelle_unite",
          "limite_qualite",
          "reference_qualite",
          "conformite_parametre"
        ].join(",")
      );

      const r = await fetch(url.toString());
      if(!r.ok) throw new Error("Hub'Eau API error");
      const json = await r.json();

      const rows = Array.isArray(json?.data) ? json.data : [];
      if(rows.length === 0) return { latest: null, distinctSamples: 0, rows: [] };

      // Find latest date + its sample id (grouped by code_prelevement)
      // Since sort=desc, the first row should be among the latest, but we compute to be safe.
      const bySample = new Map(); // sampleId -> {date, row}
      for(const row of rows){
        const sid = row.code_prelevement;
        const dt = row.date_prelevement ? new Date(row.date_prelevement) : null;
        if(!sid || !dt || Number.isNaN(dt.getTime())) continue;

        const existing = bySample.get(sid);
        if(!existing || dt > existing.date){
          bySample.set(sid, { date: dt, row });
        }
      }

      if(bySample.size === 0) return { latest: null, distinctSamples: 0 };

      let latest = null;
      for(const v of bySample.values()){
        if(!latest || v.date > latest.date) latest = v;
      }

      return { latest, distinctSamples: bySample.size, rows };

    }

    // -----------------------------
    // Rendering
    // -----------------------------
    function renderChoices(communes){
      const container = $("choices");
      container.innerHTML = "";
      if(!communes || communes.length === 0) return;

      communes.slice(0, 10).forEach(c => {
        const div = document.createElement("div");
        div.className = "choice";
        div.tabIndex = 0;
        const cp = Array.isArray(c.codesPostaux) ? c.codesPostaux.join(", ") : "‚Äî";
        div.innerHTML = `
          <div>
            <strong>${escapeHtml(c.nom || "‚Äî")}</strong>
            <small>INSEE: ${escapeHtml(c.code || "‚Äî")} ‚Ä¢ CP: ${escapeHtml(cp)}</small>
          </div>
          <div class="muted" style="font-weight:650;">Choisir ‚Üí</div>
        `;
        div.addEventListener("click", () => selectCommune(c));
        div.addEventListener("keydown", (e) => {
          if(e.key === "Enter" || e.key === " ") selectCommune(c);
        });
        container.appendChild(div);
      });
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, (m) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    async function selectCommune(commune){
      clearToast();
      $("choices").innerHTML = "";
      $("resultsCard").style.display = "none";

      const city = commune?.nom || "‚Äî";
      const insee = commune?.code || "‚Äî";
      const pop = commune?.population ?? null;

      $("kpiCity").textContent = city;
      $("kpiInsee").textContent = `Code INSEE : ${insee}`;
      $("kpiPop").textContent = (typeof pop === "number") ? formatInt(pop) : "‚Äî";

      setLoading(true);
      try{
        const res = await fetchLatestWaterSample(insee);
        if(!res.latest){
          showToast("Aucun r√©sultat Hub‚ÄôEau trouv√© pour cette commune (ou pas de date exploitable).");
          setLoading(false);
          return;
        }

        const row = res.latest.row;


        if(res.rows && res.rows.length){
          renderDetailedAnalyses(res.rows, row.code_prelevement);
          detectPFAS(res.rows, row.code_prelevement);
        }




        // Overall compliance (conclusion)
        const overall = normalizeConformityOverall(row.conclusion_conformite_prelevement);
        const overallBadge = $("kpiOverallBadge");
        overallBadge.className = `badge ${overall.cls}`;
        overallBadge.textContent = overall.label;
        $("kpiOverallText").textContent = overall.text || "‚Äî";

        // Bacteriological
        const bact = normalizeOuiNon(row.conformite_limites_bact_prelevement);
        const bactBadge = $("kpiBactBadge");
        bactBadge.className = `badge ${bact.cls}`;
        bactBadge.textContent = bact.label;

        // Chemical / physico-chemical
        const chem = normalizeOuiNon(row.conformite_limites_pc_prelevement);
        const chemBadge = $("kpiChemBadge");
        chemBadge.className = `badge ${chem.cls}`;
        chemBadge.textContent = chem.label;

        // Dates / sample id
        $("kpiLastDate").textContent = formatDateISOToFR(row.date_prelevement);
        $("kpiSampleId").textContent =
          `Dernier pr√©l√®vement : ${row.code_prelevement || "‚Äî"} ‚Ä¢ R√©seau : ${row.nom_reseau || row.code_reseau || "‚Äî"} ‚Ä¢ Pr√©l√®vements trouv√©s (page 1): ${res.distinctSamples}`;

        $("resultsCard").style.display = "block";
      }catch(err){
        console.error(err);
        showToast("Erreur lors de l‚Äôappel API. R√©essayez dans un instant.");
      }finally{
        setLoading(false);
      }
    }

    // -----------------------------
    // Search / Geolocate
    // -----------------------------
    async function onSearch(){
      clearToast();
      $("choices").innerHTML = "";
      $("resultsCard").style.display = "none";

      const raw = $("q").value.trim();
      if(!raw){
        showToast("Entrez une ville ou un code postal.");
        return;
      }

      setLoading(true);
      try{
        let communes = [];
        const isPostal = /^[0-9]{5}$/.test(raw);

        if(isPostal){
          communes = await geoSearchByPostal(raw);
        }else{
          communes = await geoSearchByName(raw);
        }

        if(!Array.isArray(communes) || communes.length === 0){
          showToast("Aucune commune trouv√©e. V√©rifiez l‚Äôorthographe ou essayez un code postal.");
          return;
        }

        // If one obvious result, auto-select; else show choices
        if(communes.length === 1){
          await selectCommune(communes[0]);
        }else{
          renderChoices(communes);
        }
      }catch(err){
        console.error(err);
        showToast("Impossible d‚Äôinterroger geo.api.gouv.fr. R√©essayez.");
      }finally{
        setLoading(false);
      }
    }

    async function onLocate(){
      clearToast();
      $("choices").innerHTML = "";
      $("resultsCard").style.display = "none";

      if(!("geolocation" in navigator)){
        showToast("La g√©olocalisation n‚Äôest pas disponible sur ce navigateur.");
        return;
      }

      setLoading(true);
      try{
        const pos = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, {
            enableHighAccuracy: false,
            timeout: 12000,
            maximumAge: 60000
          });
        });

        const { latitude, longitude } = pos.coords;

        const communes = await geoByLatLon(latitude, longitude);
        if(!Array.isArray(communes) || communes.length === 0){
          showToast("G√©olocalisation OK, mais aucune commune retourn√©e. Essayez la recherche manuelle.");
          return;
        }

        // Usually first is best match
        await selectCommune(communes[0]);
      }catch(err){
        console.error(err);
        showToast("G√©olocalisation refus√©e ou impossible. Essayez la recherche manuelle.");
      }finally{
        setLoading(false);
      }
    }

    // Bind
    $("btnSearch").addEventListener("click", onSearch);
    $("btnLocate").addEventListener("click", onLocate);
    $("q").addEventListener("keydown", (e) => {
      if(e.key === "Enter") onSearch();
    });

    function isBlank(v){ return v === null || v === undefined || String(v).trim() === ""; }

function formatResult(row){
  const num = row.resultat_numerique;
  const txt = row.resultat_textuel;
  const unit = row.libelle_unite;

  if(!isBlank(num)){
    return `${num}${isBlank(unit) ? "" : " " + unit}`;
  }
  if(!isBlank(txt)) return String(txt);
  return "‚Äî";
}

function keywordMatch(label, keywords){
  const s = (label || "").toUpperCase();
  return keywords.some(k => s.includes(k));
}

// Calculs Analyse de don√©es VS limites

function findThresholdForLabel(label){
  const s = label || "";
  for(const t of THRESHOLDS){
    if(t.match?.some(rx => rx.test(s))) return t;
  }
  return null;
}

function evalAgainstThreshold(row, threshold){
  // Pas de seuil exploitable => "pas de donn√©e"
  if(!threshold || threshold.rule === "none" || threshold.rule === "special"){
    return { status:"unk", icon:"circle-slash", hint: threshold?.note || "Seuil non d√©fini." };
  }

  // On ne compare que si on a une valeur num√©rique
  const v = Number(row.resultat_numerique);
  if(Number.isNaN(v)){
    return { status:"unk", icon:"circle-slash", hint:"R√©sultat non num√©rique / non comparable." };
  }

  // Comparaisons
  if(threshold.rule === "max"){
    const ok = v <= threshold.value;
    return {
      status: ok ? "ok" : "bad",
      icon: ok ? "circle-check" : "circle-x",
      hint: `${threshold.type === "limit" ? "Limite" : "R√©f."} ‚â§ ${threshold.value} ${threshold.unit}`
    };
  }

  if(threshold.rule === "range"){
    const ok = v >= threshold.min && v <= threshold.max;
    return {
      status: ok ? "ok" : "bad",
      icon: ok ? "circle-check" : "circle-x",
      hint: `${threshold.type === "limit" ? "Limite" : "R√©f."} ${threshold.min}‚Äì${threshold.max} ${threshold.unit}`
    };
  }

  return { status:"unk", icon:"circle-slash", hint:"Non comparable." };
}

// Cat√©gorisation simple (par mots-cl√©s)
const MICRO_KEYS = [
  "E. COLI", "ESCHERICHIA COLI", "ENT√âROCO", "ENTEROCO",
  "COLIFORM", "GERMES REVIVIFIABLES", "REVIVIFIABLE"
];

const PHYS_KEYS = [
  "PH", "CONDUCTIV", "TEMP√âRAT", "TEMPERAT", "TURBIDIT", "COULEUR", "ODEUR"
];

// Chimique = tout ce qui n'est pas micro/phys (inclut nitrates, m√©taux, pesticides, PFAS, solvants)
function categorizeRow(row){
  const label = row.libelle_parametre || "";
  if(keywordMatch(label, MICRO_KEYS)) return "micro";
  if(keywordMatch(label, PHYS_KEYS)) return "phys";
  return "chem";
}

function buildTable(rows){
  if(!rows || rows.length === 0){
    return `<div class="muted">Aucun param√®tre trouv√© pour cette cat√©gorie sur le dernier pr√©l√®vement.</div>`;
  }

  const sorted = [...rows].sort((a,b) => (a.libelle_parametre||"").localeCompare(b.libelle_parametre||""));

  const header = `
    <table class="param-table">
      <thead>
        <tr>
          <th>Param√®tre</th>
          <th>R√©sultat</th>
          <th>Statut</th>
        </tr>
      </thead>
      <tbody>
  `;

  const body = sorted.map(r => {
    const name = escapeHtml(r.libelle_parametre || "‚Äî");
    const result = escapeHtml(formatResult(r));

    const thr = findThresholdForLabel(r.libelle_parametre);
    const eva = evalAgainstThreshold(r, thr);

    const iconName = eva.icon || "circle-slash";
    const statusCls = eva.status || "unk";
    const hint = eva.hint ? escapeHtml(eva.hint) : "‚Äî";

    return `
      <tr>
        <td>
          <div style="font-weight:700">${name}</div>
          ${isBlank(r.code_parametre) ? "" : `<div style="margin-top:6px"><span class="code-pill">code ${escapeHtml(r.code_parametre)}</span></div>`}
        </td>
        <td>${result}</td>
        <td>
          <span class="tip status-icon ${statusCls}" data-tip="${hint}">
            <i data-lucide="${iconName}"></i>
          </span>
        </td>
      </tr>
    `;
  }).join("");

  return header + body + `</tbody></table>`;
}

function renderDetailedAnalyses(allRows, latestSampleId){
  // Garde uniquement les lignes du dernier pr√©l√®vement
  const sampleRows = allRows.filter(r => r.code_prelevement === latestSampleId);

  // Cat√©gorise
  const micro = [];
  const chem = [];
  const phys = [];

  for(const r of sampleRows){
    const cat = categorizeRow(r);
    if(cat === "micro") micro.push(r);
    else if(cat === "phys") phys.push(r);
    else chem.push(r);
  }

  $("countMicro").textContent = micro.length ? `${micro.length} param√®tres` : "0";
  $("countChem").textContent  = chem.length  ? `${chem.length} param√®tres`  : "0";
  $("countPhys").textContent  = phys.length  ? `${phys.length} param√®tres`  : "0";

  $("microContent").innerHTML = buildTable(micro);
  $("chemContent").innerHTML  = buildTable(chem);
  $("physContent").innerHTML  = buildTable(phys);
  
  if (window.lucide && typeof window.lucide.createIcons === "function") {
  window.lucide.createIcons();
  }
}


// Accord√©ons: open/close
document.addEventListener("click", (e) => {
  const btn = e.target.closest(".acc-btn");
  if(!btn) return;

  const key = btn.getAttribute("data-acc");
  const panel = document.getElementById(`panel-${key}`);
  const isOpen = panel.classList.contains("open");

  panel.classList.toggle("open", !isOpen);
  btn.classList.toggle("open", !isOpen);
});

// Mobile tap tooltips: tap icon to toggle, tap outside to close
document.addEventListener("click", (e) => {
  const tip = e.target.closest(".tip");
  const isTouchLike = window.matchMedia && window.matchMedia("(hover: none)").matches;

  // Only enforce click-to-open on touch-like devices
  if(!isTouchLike) return;

  // If user tapped a tooltip icon: toggle it and close others
  if(tip){
    document.querySelectorAll(".tip.is-open").forEach(el => {
      if(el !== tip) el.classList.remove("is-open");
    });
    tip.classList.toggle("is-open");
    e.stopPropagation();
    return;
  }

  // Tap outside: close all
  document.querySelectorAll(".tip.is-open").forEach(el => el.classList.remove("is-open"));
});

// Close tooltips on scroll (mobile)
window.addEventListener("scroll", () => {
  document.querySelectorAll(".tip.is-open").forEach(el => el.classList.remove("is-open"));
}, { passive: true });

  </script>
</body>
</html>
